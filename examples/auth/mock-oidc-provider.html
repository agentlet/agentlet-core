<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock OIDC Provider</title>
    <link rel="icon" type="image/x-icon" href="../../resources/favicons/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .login-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e1e5e9;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }

        .provider-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .provider-logo {
            width: 48px;
            height: 48px;
            background: #495057;
            border-radius: 8px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .provider-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .provider-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #495057;
            box-shadow: 0 0 0 3px rgba(73, 80, 87, 0.1);
        }

        .login-button {
            width: 100%;
            background: #495057;
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 0.75rem;
        }

        .login-button:hover {
            background: #343a40;
        }

        .login-button:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
        }

        .error-button {
            width: 100%;
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.875rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-bottom: 0.5rem;
        }

        .error-button:hover {
            background: #c82333;
        }

        .demo-users {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #dee2e6;
        }

        .demo-users h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .demo-user {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .demo-user:hover {
            background: #e9ecef;
        }

        .status-message {
            text-align: center;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .cancel-link {
            text-align: center;
            margin-top: 1rem;
        }

        .cancel-link a {
            color: #666;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .cancel-link a:hover {
            color: #333;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="provider-header">
            <div class="provider-logo">üîê</div>
            <h1 class="provider-title">Mock OIDC Provider</h1>
            <p class="provider-subtitle">Demo authentication service for agentlet examples</p>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <form class="login-form" id="loginForm">
            <div class="form-group">
                <label class="form-label" for="username">Username</label>
                <input type="text" id="username" name="username" class="form-input"
                       placeholder="Enter username" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="password">Password</label>
                <input type="password" id="password" name="password" class="form-input"
                       placeholder="Enter password" required>
            </div>

            <button type="submit" class="login-button" id="loginBtn">
                Sign in
            </button>
        </form>

        <div class="demo-users">
            <h4>Demo credentials (click to use):</h4>
            <div class="demo-user" onclick="fillCredentials('john.doe', 'password123')">
                john.doe / password123 (Admin)
            </div>
            <div class="demo-user" onclick="fillCredentials('jane.smith', 'demo2024')">
                jane.smith / demo2024 (User)
            </div>
            <div class="demo-user" onclick="fillCredentials('test.user', 'testpass')">
                test.user / testpass (Guest)
            </div>
        </div>

        <button type="button" class="error-button" onclick="simulateError()">
            Simulate auth error
        </button>

        <div class="cancel-link">
            <a href="#" onclick="cancelAuth()">Cancel authentication</a>
        </div>
    </div>

    <script>
        // Mock user database
        const mockUsers = {
            'john.doe': {
                password: 'password123',
                profile: {
                    id: 'user_001',
                    username: 'john.doe',
                    email: 'john.doe@example.com',
                    name: 'John Doe',
                    role: 'admin',
                    permissions: ['read', 'write', 'admin']
                }
            },
            'jane.smith': {
                password: 'demo2024',
                profile: {
                    id: 'user_002',
                    username: 'jane.smith',
                    email: 'jane.smith@example.com',
                    name: 'Jane Smith',
                    role: 'user',
                    permissions: ['read', 'write']
                }
            },
            'test.user': {
                password: 'testpass',
                profile: {
                    id: 'user_003',
                    username: 'test.user',
                    email: 'test.user@example.com',
                    name: 'Test User',
                    role: 'guest',
                    permissions: ['read']
                }
            }
        };

        // DOM elements
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Form submission handler
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleLogin();
        });

        // Fill demo credentials
        function fillCredentials(username, password) {
            usernameInput.value = username;
            passwordInput.value = password;
            usernameInput.focus();
            showStatus('Demo credentials filled. Click "Sign in" to authenticate.', 'info');
        }

        // Handle login process
        async function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showStatus('Please enter both username and password.', 'error');
                return;
            }

            // Disable form during authentication
            setFormDisabled(true);
            showStatus('Authenticating...', 'info');

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Validate credentials
            const user = mockUsers[username];
            if (!user || user.password !== password) {
                showStatus('Invalid username or password.', 'error');
                setFormDisabled(false);
                return;
            }

            // Generate mock tokens
            const authResult = generateAuthTokens(user);

            showStatus('Authentication successful! Redirecting...', 'success');

            // Send tokens to parent window
            setTimeout(() => {
                sendAuthResult(authResult);
            }, 1000);
        }

        // Generate mock authentication tokens
        function generateAuthTokens(user) {
            const now = new Date();
            const expiresAt = new Date(now.getTime() + 3600000); // 1 hour

            // Generate mock JWT-like tokens (base64 encoded JSON for demo purposes)
            const accessToken = btoa(JSON.stringify({
                type: 'access_token',
                sub: user.profile.id,
                username: user.profile.username,
                email: user.profile.email,
                role: user.profile.role,
                permissions: user.profile.permissions,
                iat: Math.floor(now.getTime() / 1000),
                exp: Math.floor(expiresAt.getTime() / 1000),
                iss: 'mock-oidc-provider',
                aud: 'agentlet-core-example'
            }));

            const refreshToken = btoa(JSON.stringify({
                type: 'refresh_token',
                sub: user.profile.id,
                iat: Math.floor(now.getTime() / 1000),
                exp: Math.floor((now.getTime() + 30 * 24 * 3600000) / 1000), // 30 days
            }));

            const idToken = btoa(JSON.stringify({
                type: 'id_token',
                sub: user.profile.id,
                name: user.profile.name,
                email: user.profile.email,
                username: user.profile.username,
                iat: Math.floor(now.getTime() / 1000),
                exp: Math.floor(expiresAt.getTime() / 1000),
                iss: 'mock-oidc-provider',
                aud: 'agentlet-core-example'
            }));

            return {
                access_token: `mock_access_${accessToken}`,
                refresh_token: `mock_refresh_${refreshToken}`,
                id_token: `mock_id_${idToken}`,
                token_type: 'Bearer',
                expires_in: 3600,
                scope: 'openid profile email',
                user_info: user.profile
            };
        }


        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';

            // Auto-hide info messages after 5 seconds
            if (type === 'info') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }

        // Enable/disable form elements
        function setFormDisabled(disabled) {
            usernameInput.disabled = disabled;
            passwordInput.disabled = disabled;
            loginBtn.disabled = disabled;
            loginBtn.textContent = disabled ? 'Signing in...' : 'Sign in';
        }

        // Simulate authentication error
        function simulateError() {
            showStatus('Simulating authentication error...', 'info');

            setTimeout(() => {
                if (window.opener) {
                    try {
                        window.opener.postMessage({
                            type: 'auth_result',
                            success: false,
                            error: 'Authentication server temporarily unavailable. Please try again later.'
                        }, window.location.origin);

                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    } catch (error) {
                        console.error('Failed to send error to parent:', error);
                        showStatus('Failed to communicate with parent window.', 'error');
                    }
                } else {
                    showStatus('No parent window found for error simulation.', 'error');
                }
            }, 1000);
        }

        // Cancel authentication
        function cancelAuth() {
            if (window.opener) {
                try {
                    window.opener.postMessage({
                        type: 'auth_cancel'
                    }, window.location.origin);

                    window.close();
                } catch (error) {
                    console.error('Failed to send cancellation to parent:', error);
                    showStatus('Failed to communicate with parent window.', 'error');
                }
            } else {
                // Just close the window if no parent
                window.close();
            }
        }

        // Handle window close button (user cancels by closing popup)
        window.addEventListener('beforeunload', () => {
            if (window.opener && !document.body.dataset.authCompleted) {
                try {
                    window.opener.postMessage({
                        type: 'auth_cancel'
                    }, window.location.origin);
                } catch (error) {
                    console.error('Failed to send cancellation on window close:', error);
                }
            }
        });

        // Mark auth as completed when sending result
        function sendAuthResult(authResult) {
            if (window.opener) {
                try {
                    // Mark as completed to prevent cancel message on window close
                    document.body.dataset.authCompleted = 'true';

                    window.opener.postMessage({
                        type: 'auth_result',
                        success: true,
                        token: authResult.access_token,  // AuthManager expects 'token' field
                        ...authResult
                    }, window.location.origin);

                    // Close popup after successful auth
                    setTimeout(() => {
                        window.close();
                    }, 500);
                } catch (error) {
                    console.error('Failed to send auth result to parent:', error);
                    showStatus('Failed to communicate with parent window.', 'error');
                    setFormDisabled(false);
                    document.body.dataset.authCompleted = 'false';
                }
            } else {
                showStatus('No parent window found. This page should be opened as a popup.', 'error');
                setFormDisabled(false);
            }
        }

        // Focus on username field when page loads
        window.addEventListener('load', () => {
            usernameInput.focus();
        });
    </script>
</body>
</html>