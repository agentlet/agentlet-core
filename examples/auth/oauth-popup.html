<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Popup Authentication - Agentlet Core Example</title>
    <link rel="icon" type="image/x-icon" href="../../resources/favicons/favicon.ico">
    <link rel="stylesheet" href="../shared/examples.css">
    <link rel="stylesheet" href="../shared/two-column-layout.css">
</head>
<body>
    <div class="container">
        <div class="two-column-container">
            <!-- Left Column: Content and Controls -->
            <div class="left-column">
                <div class="nav-breadcrumb">
                    <a href="../index.html">Examples</a> ‚Üí
                    <a href="../index.html#auth">auth</a> ‚Üí
                    <span>oauth-popup</span>
                </div>

                <h1>OAuth popup authentication</h1>

                <p>This example demonstrates popup-based OAuth/OIDC authentication using a simulated identity provider.
                The authentication flow opens a popup window, handles user login, and securely returns tokens to the parent window.</p>

                <div class="example-section">
                    <h3>What this example shows:</h3>
                    <ul>
                        <li>Popup-based authentication flow with mock OIDC provider</li>
                        <li>Secure token exchange using postMessage API</li>
                        <li>Custom token extraction and processing</li>
                        <li>Authentication state management and event handling</li>
                        <li>Integration with agentlet panel and event system</li>
                    </ul>
                </div>

                <div class="controls">
                    <h4>Initialize</h4>
                    <button id="initBtn" onclick="initAgentlet()">Initialize agentlet with auth</button>
                </div>
            </div>

            <!-- Right Column: Console and Status -->
            <div class="right-column">
                <div class="console-header">
                    <h3>üìü Console Output</h3>
                    <button onclick="clearConsole()" class="console-clear-btn">üóëÔ∏è Clear</button>
                </div>
                <div class="console-section" id="console"></div>

            </div>
        </div>

        </div>

        <section class="code-examples">
            <h2>Implementation examples</h2>

            <div class="code-block">
                <h3>Basic OAuth configuration</h3>
                <pre><code class="language-javascript">// Initialize agentlet with OAuth configuration
const agentlet = new AgentletCore({
    auth: {
        enabled: true,
        buttonText: 'Login',
        loginUrl: './mock-oidc-provider.html',
        popupWidth: 480,
        popupHeight: 600,
        onSuccess: (result) => {
            console.log('Login successful:', result);
            // Handle successful authentication
        },
        onError: (error) => {
            console.error('Login failed:', error);
            // Handle authentication error
        },
        onCancel: () => {
            console.log('Login cancelled by user');
            // Handle user cancellation
        }
    }
});</code></pre>
            </div>

            <div class="code-block">
                <h3>Custom token extraction</h3>
                <pre><code class="language-javascript">// Custom token extractor for specific OIDC provider
const authConfig = {
    enabled: true,
    loginUrl: 'https://your-oidc-provider.com/auth',
    tokenExtractor: (data) => {
        // Handle different response formats
        if (data.access_token) {
            return {
                accessToken: data.access_token,
                refreshToken: data.refresh_token,
                idToken: data.id_token,
                expiresIn: data.expires_in
            };
        }
        return null;
    },
    messageHandler: (data, authManager) => {
        // Custom message processing
        if (data.type === 'custom_auth_response') {
            const token = extractCustomToken(data);
            authManager.handleSuccess(token, data);
        }
    }
};</code></pre>
            </div>

            <div class="code-block">
                <h3>Event-driven authentication</h3>
                <pre><code class="language-javascript">// Listen for authentication events
window.agentlet.eventBus.on('auth:success', (result) => {
    console.log('Authentication successful:', result);
    updateUI(result.token);
});

window.agentlet.eventBus.on('auth:error', (error) => {
    console.error('Authentication failed:', error);
    showErrorMessage(error.error);
});

window.agentlet.eventBus.on('auth:cancel', () => {
    console.log('Authentication cancelled');
    resetAuthUI();
});

// Programmatic authentication
async function authenticateUser() {
    try {
        await window.agentlet.auth.startAuthentication();
    } catch (error) {
        console.error('Failed to start authentication:', error);
    }
}</code></pre>
            </div>
        </section>
    </div>

    <script src="../shared/console-utils.js"></script>
    <script>
        let currentToken = null;
        let agentletInstance = null;

        // Authentication configuration
        const authConfig = {
            enabled: true,
            buttonText: 'Login',
            buttonIcon: 'üîê',
            loginUrl: './mock-oidc-provider.html',
            popupWidth: 480,
            popupHeight: 600,
            allowedOrigins: [window.location.origin],
            onSuccess: (result) => {
                log('üéâ Authentication successful!', 'success');
                log(`Token received: ${result.token.substring(0, 20)}...`);
                log(`User info: ${JSON.stringify(result.userInfo || {}, null, 2)}`);
                currentToken = result.token;
            },
            onError: (error) => {
                log(`‚ùå Authentication failed: ${error.error}`, 'error');
            },
            onCancel: () => {
                log('üö´ Authentication cancelled by user', 'warning');
            },
            tokenExtractor: (data) => {
                // Custom token extraction for our mock provider
                if (typeof data === 'object' && data.access_token) {
                    return data.access_token;
                }
                return null;
            }
        };

        async function initAgentlet() {
            try {
                log('üöÄ Starting agentlet initialization with OAuth configuration...');

                // Load the agentlet core script
                if (!window.AgentletCore) {
                    log('üì¶ Loading agentlet core script...');
                    await loadScript('../../dist/agentlet-core.js');
                    log('‚úÖ Agentlet core script loaded successfully');
                }

                // Create AgentletCore instance with auth configuration
                log('üîß Creating AgentletCore instance with authentication...');
                const AgentletCoreClass = window.AgentletCore.default || window.AgentletCore.AgentletCore;
                agentletInstance = new AgentletCoreClass({
                    debugMode: true,
                    auth: authConfig
                });

                // Start initialization
                log('‚ö° Starting initialization...');
                await agentletInstance.init();

                log('‚úÖ Agentlet core initialized successfully with OAuth support');

            } catch (error) {
                log(`‚ùå Failed to initialize agentlet: ${error.message}`, 'error');
            }
        }


        // Utility function to load external scripts
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize
    </script>
</body>
</html>