<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Export - Agentlet Core Example</title>
    <link rel="icon" type="image/x-icon" href="../../resources/favicons/favicon.ico">
    <link rel="stylesheet" href="../shared/examples.css">
    <link rel="stylesheet" href="../shared/two-column-layout.css">
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="two-column-container">
            <!-- Left Column: Content and Controls -->
            <div class="left-column">
                <div class="nav-breadcrumb">
                    <a href="../">Examples</a> → data-processing → table-excel-export
                </div>

                <h1>Excel export</h1>

                <p>This example demonstrates Excel export capabilities using Agentlet Core's table utilities with SheetJS integration.</p>

                <div class="example-section">
                    <h3>What this example shows</h3>
                    <ul>
                        <li>Single and multiple sheet Excel exports</li>
                        <li>Custom formatting and styling options</li>
                        <li>Metadata inclusion and data validation</li>
                        <li>Extract and download in one operation</li>
                        <li>Professional workbook creation with multiple sheets</li>
                    </ul>
                </div>

                <div class="controls">
                    <h4>Initialize</h4>
                    <button onclick="initAgentlet()" id="initBtn">Initialize agentlet core</button>
                    <button onclick="checkStatus()">Check status</button>
                </div>

                <div class="controls">
                    <h4>Table export</h4>
                    <button onclick="exportSalesData()" id="salesBtn">Export sales data</button>
                    <button onclick="exportInventoryData()" id="inventoryBtn">Export inventory data (paginated)</button>
                </div>

        <div class="example-section">
            <h3>Sample data tables</h3>
            
            <table id="sales-data" class="export-table">
                <caption>Q4 2023 sales data</caption>
                <thead>
                    <tr>
                        <th>Region</th>
                        <th>Salesperson</th>
                        <th>Product</th>
                        <th>Units sold</th>
                        <th>Revenue</th>
                        <th>Commission</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>North</td>
                        <td>Alice Johnson</td>
                        <td>MacBook Pro</td>
                        <td>12</td>
                        <td>$28,788</td>
                        <td>$2,879</td>
                        <td>2023-10-15</td>
                    </tr>
                    <tr>
                        <td>South</td>
                        <td>Bob Wilson</td>
                        <td>iPhone 15</td>
                        <td>25</td>
                        <td>$24,975</td>
                        <td>$2,498</td>
                        <td>2023-10-18</td>
                    </tr>
                    <tr>
                        <td>East</td>
                        <td>Carol Davis</td>
                        <td>iPad Air</td>
                        <td>18</td>
                        <td>$10,782</td>
                        <td>$1,078</td>
                        <td>2023-11-02</td>
                    </tr>
                    <tr>
                        <td>West</td>
                        <td>David Miller</td>
                        <td>Apple Watch</td>
                        <td>30</td>
                        <td>$11,970</td>
                        <td>$1,197</td>
                        <td>2023-11-12</td>
                    </tr>
                    <tr>
                        <td>North</td>
                        <td>Emma Brown</td>
                        <td>MacBook Air</td>
                        <td>8</td>
                        <td>$7,992</td>
                        <td>$799</td>
                        <td>2023-12-05</td>
                    </tr>
                </tbody>
            </table>

            <div class="pagination-example">
                <h4>Large product inventory (paginated)</h4>
                <table id="inventory-table" class="export-table">
                    <caption>Product Inventory (Page <span id="currentPage">1</span> of <span id="totalPages">15</span>)</caption>
                    <thead>
                        <tr>
                            <th>Product ID</th>
                            <th>Product Name</th>
                            <th>Category</th>
                            <th>Stock</th>
                            <th>Price</th>
                            <th>Supplier</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Content will be populated by JavaScript -->
                    </tbody>
                </table>

                <div class="pagination-controls">
                    <button id="prevPageBtn" onclick="previousPage()" disabled>Previous</button>
                    <span>Page <span id="pageIndicator">1</span> of <span id="totalPagesIndicator">15</span></span>
                    <button id="nextPageBtn" onclick="nextPage()">Next</button>
                </div>
            </div>
        </div>

                <div class="example-section">
                    <h3>Excel export API reference</h3>
                    <div class="code-block">
                        <h4>Simple table export</h4>
                        <pre><code class="language-javascript">// Extract and export a simple table
const salesTable = document.getElementById('sales-data');
const tableData = window.agentlet.tables.extract(salesTable);

const result = window.agentlet.tables.download(tableData, {
    filename: 'q4-2023-sales-data.xlsx',
    sheetName: 'Sales Data',
    includeMetadata: true
});</code></pre>

                        <h4>Paginated table export</h4>
                        <pre><code class="language-javascript">// Extract all pages from a paginated table
const inventoryTable = document.getElementById('inventory-table');

const extractedData = await window.agentlet.tables.extractAll(inventoryTable, {
    nextButtonSelector: '#nextPageBtn',
    maxPages: 15,
    delay: 500  // ms between page navigation
});

const result = window.agentlet.tables.download(extractedData, {
    filename: 'complete-inventory-data.xlsx',
    sheetName: 'Inventory',
    includeMetadata: true
});</code></pre>

                        <h4>Extract and download in one step</h4>
                        <pre><code class="language-javascript">// Direct extract and download for simple tables
const result = await window.agentlet.tables.extractAndDownload(salesTable, {
    filename: 'sales-export.xlsx'
});

// For paginated tables, use extractAll first
const allData = await window.agentlet.tables.extractAll(inventoryTable, {
    nextButtonSelector: '#nextPageBtn',
    maxPages: 15
});
const result = window.agentlet.tables.download(allData, {
    filename: 'inventory-export.xlsx'
});</code></pre>
                    </div>
                </div>
            </div>

            <!-- Right Column: Console and Status -->
            <div class="right-column">
                <div class="console-header">
                    <h3>Console output</h3>
                    <button onclick="clearConsole()" class="console-clear-btn">Clear</button>
                </div>
                <div class="console-section" id="console"></div>
                
                <h3>Status</h3>
                <div class="status-section" id="status">
                    Click "Initialize Agentlet Core" to start the demo.
                </div>
            </div>
        </div>
    </div>

    <!-- Console utilities -->
    <script src="../shared/console-utils.js"></script>

    <style>
        .export-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 13px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .export-table caption {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #495057;
            padding: 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }
        
        .export-table th {
            background: #28a745;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #1e7e34;
            font-size: 12px;
        }
        
        .export-table td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
        }
        
        .export-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .export-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        /* Export progress indication */
        .exporting-table {
            outline: 3px solid #ffc107;
            outline-offset: 2px;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .exported-table {
            outline: 3px solid #28a745;
            outline-offset: 2px;
            background: rgba(40, 167, 69, 0.1);
        }

        /* Pagination styling */
        .pagination-example {
            margin: 20px 0;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .pagination-controls button {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            color: black;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        // Configure Agentlet
        window.agentletConfig = {
            debugMode: true,
            theme: 'default',
            startMinimized: true  // Start with panel minimized
        };

        // Pagination variables
        let currentPageNumber = 1;
        let totalPagesCount = 15;

        // Sample paginated inventory data (15 pages with 10 items each)
        const paginatedInventoryData = {
            1: [
                ['INV001', 'MacBook Pro 16"', 'Laptops', '25', '$2,499.00', 'Apple Inc.', '2024-01-15'],
                ['INV002', 'Dell XPS 13', 'Laptops', '18', '$1,299.00', 'Dell Technologies', '2024-01-14'],
                ['INV003', 'HP Spectre x360', 'Laptops', '12', '$1,199.00', 'HP Inc.', '2024-01-13'],
                ['INV004', 'ThinkPad X1 Carbon', 'Laptops', '8', '$1,799.00', 'Lenovo', '2024-01-12'],
                ['INV005', 'Surface Laptop 5', 'Laptops', '15', '$1,399.00', 'Microsoft', '2024-01-11'],
                ['INV006', 'iPhone 15 Pro', 'Smartphones', '45', '$999.00', 'Apple Inc.', '2024-01-10'],
                ['INV007', 'Samsung Galaxy S24', 'Smartphones', '32', '$899.00', 'Samsung', '2024-01-09'],
                ['INV008', 'Pixel 8 Pro', 'Smartphones', '22', '$899.00', 'Google', '2024-01-08'],
                ['INV009', 'OnePlus 12', 'Smartphones', '16', '$799.00', 'OnePlus', '2024-01-07'],
                ['INV010', 'Xiaomi 14 Ultra', 'Smartphones', '28', '$1,299.00', 'Xiaomi', '2024-01-06']
            ],
            2: [
                ['INV011', 'iPad Pro 12.9"', 'Tablets', '20', '$1,099.00', 'Apple Inc.', '2024-01-05'],
                ['INV012', 'Surface Pro 9', 'Tablets', '14', '$999.00', 'Microsoft', '2024-01-04'],
                ['INV013', 'Galaxy Tab S9+', 'Tablets', '18', '$999.00', 'Samsung', '2024-01-03'],
                ['INV014', 'iPad Air 5th Gen', 'Tablets', '25', '$599.00', 'Apple Inc.', '2024-01-02'],
                ['INV015', 'Lenovo Tab P11 Pro', 'Tablets', '12', '$449.00', 'Lenovo', '2024-01-01'],
                ['INV016', 'Apple Watch Ultra 2', 'Wearables', '30', '$799.00', 'Apple Inc.', '2023-12-30'],
                ['INV017', 'Samsung Galaxy Watch 6', 'Wearables', '24', '$329.00', 'Samsung', '2023-12-29'],
                ['INV018', 'Garmin Fenix 7', 'Wearables', '15', '$699.00', 'Garmin', '2023-12-28'],
                ['INV019', 'Fitbit Sense 2', 'Wearables', '35', '$299.00', 'Google', '2023-12-27'],
                ['INV020', 'Amazfit GTR 4', 'Wearables', '28', '$199.00', 'Amazfit', '2023-12-26']
            ],
            3: [
                ['INV021', 'AirPods Pro 2nd Gen', 'Audio', '50', '$249.00', 'Apple Inc.', '2023-12-25'],
                ['INV022', 'Sony WH-1000XM5', 'Audio', '22', '$399.00', 'Sony', '2023-12-24'],
                ['INV023', 'Bose QuietComfort 45', 'Audio', '18', '$329.00', 'Bose', '2023-12-23'],
                ['INV024', 'Sennheiser HD 660S2', 'Audio', '8', '$599.00', 'Sennheiser', '2023-12-22'],
                ['INV025', 'JBL Live 660NC', 'Audio', '25', '$199.00', 'JBL', '2023-12-21'],
                ['INV026', 'Canon EOS R5', 'Cameras', '5', '$3,899.00', 'Canon', '2023-12-20'],
                ['INV027', 'Sony Alpha a7 IV', 'Cameras', '7', '$2,499.00', 'Sony', '2023-12-19'],
                ['INV028', 'Nikon Z9', 'Cameras', '3', '$5,499.00', 'Nikon', '2023-12-18'],
                ['INV029', 'Fujifilm X-T5', 'Cameras', '6', '$1,699.00', 'Fujifilm', '2023-12-17'],
                ['INV030', 'Panasonic Lumix GH6', 'Cameras', '4', '$2,199.00', 'Panasonic', '2023-12-16']
            ]
        };


        function checkStatus() {
            log('Checking Agentlet and tables status...');
            
            if (window.agentlet && window.agentlet.tables) {
                log('Tables API is available', 'success');
                log(`Available methods: ${Object.keys(window.agentlet.tables).join(', ')}`);
                log(`Export methods available: download, extractAndDownload`);
                updateStatus('Tables API ready for Excel export!', 'success');
            } else if (window.agentlet) {
                log('Agentlet loaded but tables API not found', 'warning');
                updateStatus('Agentlet loaded but tables API not available', 'warning');
            } else {
                log('Agentlet not initialized yet', 'warning');
                updateStatus('Please initialize Agentlet Core first', 'warning');
            }
        }

        async function initAgentlet() {
            try {
                setButtonLoading('initBtn', true);
                updateStatus('Loading Agentlet Core...', 'info');
                log('Initializing Agentlet Core...');

                if (window.agentlet) {
                    log('Agentlet already loaded', 'warning');
                    updateStatus('Ready! Try the export buttons above.', 'success');
                    setButtonLoading('initBtn', false);
                    return;
                }

                // Simulate loading delay for demonstration
                await new Promise(resolve => setTimeout(resolve, 500));

                const script = document.createElement('script');
                script.src = '../../../dist/agentlet-core.js?' + Date.now();
                
                script.onload = () => {
                    log('Agentlet Core script loaded successfully', 'success');
                    
                    let AgentletConstructor = null;
                    if (window.AgentletCore) {
                        AgentletConstructor = window.AgentletCore.default;
                    }
                    
                    if (AgentletConstructor) {
                        try {
                            log('Creating AgentletCore instance...');
                            const agentletInstance = new AgentletConstructor(window.agentletConfig);
                                
                            log('Starting initialization...');
                            agentletInstance.init().then(() => {
                                if (window.agentlet && window.agentlet.tables) {
                                    log('Agentlet Core loaded with Table utilities', 'success');
                                    log(`Available table methods: ${Object.keys(window.agentlet.tables).join(', ')}`);
                                    log('Excel export capabilities ready with SheetJS integration');
                                    updateStatus('Ready! Try the Excel export buttons above.', 'success');
                                } else {
                                    log('Table utilities not available', 'error');
                                    updateStatus('Table utilities not available', 'error');
                                }
                                setButtonLoading('initBtn', false);
                            }).catch(error => {
                                log(`Initialization failed: ${error.message}`, 'error');
                                updateStatus('Initialization failed: ' + error.message, 'error');
                                setButtonLoading('initBtn', false);
                            });
                                
                        } catch (error) {
                            log(`Error creating AgentletCore instance: ${error.message}`, 'error');
                            updateStatus('Error creating instance: ' + error.message, 'error');
                            setButtonLoading('initBtn', false);
                        }
                    } else {
                        log('AgentletCore constructor not available', 'error');
                        updateStatus('AgentletCore constructor not found', 'error');
                        setButtonLoading('initBtn', false);
                    }
                };

                script.onerror = () => {
                    log('Failed to load Agentlet Core script', 'error');
                    updateStatus('Failed to load Agentlet Core. Make sure you ran "npm run build" first.', 'error');
                    setButtonLoading('initBtn', false);
                };

                document.head.appendChild(script);

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                updateStatus('Initialization error: ' + error.message, 'error');
                setButtonLoading('initBtn', false);
            }
        }

        function checkTables() {
            if (!window.agentlet || !window.agentlet.tables) {
                updateStatus('Table utilities not available. Initialize Agentlet first.', 'warning');
                return false;
            }
            return true;
        }

        function exportSalesData() {
            if (!checkTables()) return;

            try {
                setButtonLoading('salesBtn', true);
                const salesTable = document.getElementById('sales-data');
                highlightExporting(salesTable);
                
                log('Extracting sales data for export...');
                const tableData = window.agentlet.tables.extract(salesTable);
                
                log(`Sales table extracted: ${tableData.rows.length} rows, ${tableData.headers.length} columns`);
                log(`Headers: ${tableData.headers.join(', ')}`);
                
                const result = window.agentlet.tables.download(tableData, {
                    filename: 'q4-2023-sales-data.xlsx',
                    sheetName: 'Sales Data',
                    includeMetadata: true
                });
                
                log('Sales data Excel export completed:');
                log(`   File: ${result.filename || 'q4-2023-sales-data.xlsx'}`);
                log(`   Data rows: ${tableData.rows.length}`);
                log(`   Total revenue: ${tableData.rows.reduce((sum, row) => sum + parseFloat(row.Revenue?.replace(/[$,]/g, '') || 0), 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`);
                
                highlightExported(salesTable);
                trackExport('Sales Data', 1, 1);
                updateStatus(`Sales data exported: ${tableData.rows.length} records`, 'success');
                setTimeout(() => setButtonLoading('salesBtn', false), 300);
            } catch (error) {
                log(` Error exporting sales data: ${error.message}`, 'error');
                updateStatus('Sales export failed', 'error');
                setButtonLoading('salesBtn', false);
            }
        }


        // Generate more inventory data for remaining pages (simplified)
        for (let page = 4; page <= 15; page++) {
            paginatedInventoryData[page] = [];
            for (let item = 1; item <= 10; item++) {
                const id = String((page - 1) * 10 + item).padStart(3, '0');
                const products = ['Gaming Monitor', 'Wireless Mouse', 'Mechanical Keyboard', 'USB Hub', 'Webcam', 'Printer', 'Router', 'External SSD', 'Power Bank', 'Dock Station'];
                const categories = ['Accessories', 'Peripherals', 'Storage', 'Networking', 'Office'];
                const suppliers = ['Tech Corp', 'Digital Solutions', 'Hardware Plus', 'Electronics Ltd', 'Component Co'];

                paginatedInventoryData[page].push([
                    `INV${id}`,
                    products[item - 1],
                    categories[Math.floor(Math.random() * categories.length)],
                    String(Math.floor(Math.random() * 50) + 5),
                    `$${(Math.random() * 500 + 50).toFixed(2)}`,
                    suppliers[Math.floor(Math.random() * suppliers.length)],
                    `2023-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`
                ]);
            }
        }

        function exportInventoryData() {
            if (!checkTables()) return;

            try {
                setButtonLoading('inventoryBtn', true);
                const inventoryTable = document.getElementById('inventory-table');

                // Scroll to the inventory table first
                inventoryTable.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                // Wait a moment for scroll to complete before starting extraction
                setTimeout(() => {
                    highlightExporting(inventoryTable);
                    log('Extracting paginated inventory data for export...');

                    // Use extractAll method for pagination
                    window.agentlet.tables.extractAll(inventoryTable, {
                        nextButtonSelector: '#nextPageBtn',
                        maxPages: totalPagesCount,
                        delay: 500
                    }).then(extractedData => {
                        log(`Inventory table extracted: ${extractedData.rows.length} total items`);
                        log(`Pages processed: ${extractedData.metadata?.totalPages || 'unknown'}`);
                        log(`Headers: ${extractedData.headers.join(', ')}`);

                        const result = window.agentlet.tables.download(extractedData, {
                            filename: 'complete-inventory-data.xlsx',
                            sheetName: 'Inventory',
                            includeMetadata: true
                        });

                        log('Inventory data Excel export completed:');
                        log(`   File: ${result.filename || 'complete-inventory-data.xlsx'}`);
                        log(`   Total items: ${extractedData.rows.length}`);
                        log(`   Total pages: ${extractedData.metadata?.totalPages || totalPagesCount}`);

                        highlightExported(inventoryTable);
                        updateStatus(`Inventory exported: ${extractedData.rows.length} items from ${extractedData.metadata?.totalPages || totalPagesCount} pages`, 'success');
                        setTimeout(() => setButtonLoading('inventoryBtn', false), 300);
                    }).catch(error => {
                        log(`Error exporting inventory data: ${error.message}`, 'error');
                        updateStatus('Inventory export failed', 'error');
                        setButtonLoading('inventoryBtn', false);
                    });
                }, 800); // 800ms delay for smooth scroll to complete

            } catch (error) {
                log(`Error exporting inventory data: ${error.message}`, 'error');
                updateStatus('Inventory export failed', 'error');
                setButtonLoading('inventoryBtn', false);
            }
        }

        // Pagination functions
        function loadPageData(pageNumber) {
            const tbody = document.getElementById('inventoryTableBody');
            const data = paginatedInventoryData[pageNumber] || [];

            tbody.innerHTML = '';
            data.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });

            // Update page indicators
            document.getElementById('currentPage').textContent = pageNumber;
            document.getElementById('totalPages').textContent = totalPagesCount;
            document.getElementById('pageIndicator').textContent = pageNumber;
            document.getElementById('totalPagesIndicator').textContent = totalPagesCount;

            // Update button states
            document.getElementById('prevPageBtn').disabled = pageNumber === 1;
            document.getElementById('nextPageBtn').disabled = pageNumber === totalPagesCount;
        }

        function nextPage() {
            if (currentPageNumber < totalPagesCount) {
                currentPageNumber++;
                loadPageData(currentPageNumber);
            }
        }

        function previousPage() {
            if (currentPageNumber > 1) {
                currentPageNumber--;
                loadPageData(currentPageNumber);
            }
        }

        function highlightExporting(table) {
            table.classList.remove('exported-table');
            table.classList.add('exporting-table');
        }

        function highlightExported(table) {
            table.classList.remove('exporting-table');
            table.classList.add('exported-table');
            
            setTimeout(() => {
                table.classList.remove('exported-table');
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('Excel export demo ready', 'success');
            updateStatus('Ready for Agentlet initialization', 'info');

            // Load initial pagination data
            loadPageData(1);
        });
    </script>
</body>
</html>